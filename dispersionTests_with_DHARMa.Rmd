---
title: "Testing for under-/overdispersion in GLMs/GLMMs with `DHARMa`"
author: "Authors (revealed after peer review)"
date: "`r Sys.Date()`"
output: 
  rmdformats::readthedown:
    highlight: kate
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: false
editor_options: 
  chunk_output_type: inline
---

Acompanying example script from "Dispersion tests for generalized linear mixed-effects models".

Our aim is to give some instructions and show examples for testing for under/overdispersion for GLMs (base R functions `glm`) and GLMMs (package `lme4`) using the `DHARMa` package.

Users can substitute the simulated data and model by their own data and model objects[^1] to use the dispersion test function from the `DHARMa` package.

[^1]: Please verify the currently supported modeling packages in DHARMa.

Loading used packages:

```{r, message=F}
library(DHARMa) # dispersion test and other models' diagnostic
library(lme4) # for GLMMs

set.seed(2025) # for reproducible examples
```

# Dispersion tests in `DHARMa`

Dispersion tests in `DHARMa` are performed using the function `testDispersion`. You can test for:

- Both under- or overdispersion with the argument `alternative = "two.sided"` (two sided test).

- Underdispersion only with `alternative = "less"`.

- Overdispersion only with `alternative = "greater"`.

### Parametric Pearson residuals test

The parametric Pearson residuals test is peformed when using the argument `type = "PearsonChisq`, when providing the model object in the first argument position (`simulationOutput`), for example:

```{r, eval=F, echo=T}
testDispersion(model, type = "PearsonChisq") # substitute "model" by your model object name
```

Note that **parametric Perason Pearson residuals test is biased for GLMMs towards underdispersion** (more details in the main study). Tests with `alternative = "two.sided"` or `alternative = "less"` are therefore not reliable. If you have random effects in your model, we recommend to test only for overdispersion with `alternative = 'greater'`.


### Nonparametric Pearson residuals test

For the nonparametric Pearson residuals test, it is necessary a first step in generating simulations from the model using the function `simulateResiduals` with the argument `refit = TRUE`. This way, the function will record the Pearson residuals from the simulated data from parametric bootstrapping. 
Afterwards, use the resulting object in `testDispersion` with `type = "DHARMa"`:

```{r, eval=F, echo=T}
res <- simulateResiduals(model, refit = T) 
testDispersion(res, type = "DHARMa")
```

The number of simulations is set in `simulateResiduals()` with the argument `n`, which is by default 250. If your model is complex and the computational time is too long for the parametric bootstrapping, we recommend you to decrease the number of simulations (however, don't go lower than 100), or use the simulation-based response variance test explained below.


### Simulation-based response variance test

The simulation-based response variance test is available through the same functions as before, but for `simulateResiduals()` with argument `refit = F` (the default of the function):

```{r, eval=F, echo=T}
res <- simulateResiduals(model, refit = F)
testDispersion(res, type = "DHARMa")
```

For **GLMMs**, the options for simulating results **conditionally on the random effects** is currently available only for models fitted with the `lme4` package by using the argument `re.form = NULL`, which is passed to the function `simulate.merMod()` in `lme4`:

```{r, eval=F, echo=T}
res <- simulateResiduals(modelGLMM, refit = F, re.form = NULL)
testDispersion(res, type = "DHARMa")
```
 
Note that the default of the `simulateResiduals()` for GLMMs is to simulate **unconditionally on the random effects**, which would be equal to `re.form = NA` or `re.form = ~0`:

```{r, eval=F, echo=T}
res <- simulateResiduals(modelGLMM, refit = F, re.form = NA) # or re.form = ~0
testDispersion(res, type = "DHARMa")
```

# Example GLM Poisson

## Well fitted data

Generating data:

```{r}
poisData <- createData(sampleSize = 200, intercept = 0, fixedEffects = 1,
                       randomEffectVariance = 0, # no RE variance
                       overdispersion = 0, # no overdispersion added
                       family = poisson())

plot(observedResponse ~ Environment1, data = poisData)
```

Modeling with `glm` function from base R:

```{r}
poisModel <- glm(observedResponse ~ Environment1, family = poisson,
                 data = poisData)
summary(poisModel)
```

### Testing dispersion

Note that all tests present similar dispersion statistics and non-significant p-values, as expected.

1. **Nonparametric Pearson residuals test**: 

```{r}
res <- simulateResiduals(poisModel, refit = T) 
testDispersion(res, type = "DHARMa")
```

2. **Parametric Pearson residuals test** (two-sided test)

```{r}
testDispersion(poisModel, type = "PearsonChisq")
```

The same result with:
```{r}
res <- simulateResiduals(poisModel, refit = F)
testDispersion(res, type = "PearsonChisq")
```

3. **Simulation-based response variance test**

```{r}
res <- simulateResiduals(poisModel, refit = F)
testDispersion(res, type = "DHARMa")
```

## Overdispersed data

Generating overdispersed data:

```{r}
poisData <- createData(sampleSize = 200, intercept = 0, fixedEffects = 1,
                       randomEffectVariance = 0, # no RE variance
                       overdispersion = 1, # overdispersion added
                       family = poisson())

plot(observedResponse ~ Environment1, data = poisData)
```

Modeling

```{r}
poisModel <- glm(observedResponse ~ Environment1, family = poisson,
                 data = poisData)
summary(poisModel)
```

### Testing dispersion

Notice that all tests presented similar dispersion parameters and significant p-values, as expected. 

1. **Nonparametric Pearson residuals test**:

```{r}
res <- simulateResiduals(poisModel, refit = T) 
testDispersion(res, type = "DHARMa")
```

2. **Parametric Pearson residuals test** (two-sided test)

```{r}
testDispersion(poisModel, type = "PearsonChisq")
```

3. **Simulation-based response variance test**

```{r}
res <- simulateResiduals(poisModel, refit = F)
testDispersion(res, type = "DHARMa")
```

# Example GLMMs Poisson

## Well fitted data

Generating data with random intercepts:

```{r}
poisDataMM <- createData(sampleSize = 200, intercept = 0, fixedEffects = 1,
                       randomEffectVariance = 1, # added RE variance
                       overdispersion = 0, # no overdispersion added
                       family = poisson())

plot(observedResponse ~ Environment1, col = group, data = poisDataMM)
```

Modeling using `lme4`:

```{r}
poisModelMM <- glmer(observedResponse ~ Environment1 + (1|group), family = poisson,
                 data = poisDataMM)
summary(poisModelMM)
```

### Testing dispersion

Note that all dispersion statistics presented values below the expected value of 1 (around 0.88), while the simulation-based unconditional test presented the lowest dispersion statistics (0.65). 

The two-sided parametric Pearson residuals test was marginaly significant (p = 0.06), but towards underdispersion (the opposite expectation). When testing only for overdispersion with the same test, the p-value was non-significant.

1. **Nonparametric Pearson residuals test**:

```{r}
res <- simulateResiduals(poisModelMM, refit = T) 
testDispersion(res, type = "DHARMa")
```

2. **Parametric Pearson residuals test** (two-sided test)

```{r}
testDispersion(poisModelMM, type = "PearsonChisq")
```

3. **Parametric Pearson residuals test** (only overdispersion test - `alternative = "greater"`)

```{r}
testDispersion(poisModelMM, type = "PearsonChisq", alternative = "greater")
```

4. **Simulation-based response variance test: conditional simulations**

```{r}
res <- simulateResiduals(poisModelMM, refit = F, re.form = NULL)
testDispersion(res, type = "DHARMa")
```

3b. **SSimulation-based response variance test: unconditional simulations**

```{r}
res <- simulateResiduals(poisModelMM, refit = F, re.form = NA)
testDispersion(res, type = "DHARMa")
```



## Overdispersed data

Generating data with overdispersion and random intercepts:

```{r}
poisDataMM <- createData(sampleSize = 200, intercept = 0, fixedEffects = 1,
                       randomEffectVariance = 1, # added RE variance
                       overdispersion = 1, #  added overdispersion
                       family = poisson())

plot(observedResponse ~ Environment1, col = group, data = poisDataMM)
```

Modeling using `lme4`:

```{r}
poisModelMM <- glmer(observedResponse ~ Environment1 + (1|group), family = poisson,
                 data = poisDataMM)
summary(poisModelMM)
```

### Testing dispersion

Notice that the nonparameric Pearson residuals test presented some warning messages of convergence failure in models refited by the bootstrapping procedure. Convergence and other model fitting problems may arrise when applying parametric bootstrapping in GLMMs, even with a simple GLMM as the one of the example (just one random intercept). Convergence problems tend to be increase for more complex models. 

The dispersion statistics were similar across tests, except for the simulation-based unconditional test, which was also the only model to present a non-significant p-value (very low power).

1. **Nonparametric Pearson residuals test**: 
```{r}
res <- simulateResiduals(poisModelMM, refit = T) 
testDispersion(res, type = "DHARMa")
```

2. **Parametric Pearson residuals test** (two-sided test)

```{r}
testDispersion(poisModelMM, type = "PearsonChisq")
```

3. **Parametric Pearson residuals test** (only overdispersion test - `alternative = "greater"`)
```{r}
testDispersion(poisModelMM, type = "PearsonChisq", alternative = "greater")
```


4. **Simulation-based response variance test: conditional simulations**
```{r}
res <- simulateResiduals(poisModelMM, refit = F, re.form = NULL)
testDispersion(res, type = "DHARMa")
```

5. **Simulation-based response variance test: unconditional simulations**

```{r}
# Simulation-based conditional dispersion test
res <- simulateResiduals(poisModelMM, refit = F, re.form = NA)
testDispersion(res, type = "DHARMa")
```



# Session info for code reproducibility 

```{r}
sessionInfo()
```

